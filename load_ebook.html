<html>
    <head>
        <script src="https://futurepress.github.io/epubjs-reader/js/epub.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>

<style>
    #prev {
    left: 0;
}
#next {
    right: 0;
}
    .arrow {
    z-index: 1000;
        position: fixed;
        top: 50%;
        margin-top: -32px;
        font-size: 64px;
        color: #E2E2E2;
        font-family: arial, sans-serif;
        font-weight: bold;
        cursor: pointer;
        -webkit-user-select: none;
        -moz-user-select: none;
        user-select: none;
        
    }
</style>
    </head>

    <body>
        <a id="prev" href="#prev" class="arrow" style="visibility: visible;"><</a>
        <a id="next" href="#next" class="arrow" style="visibility: visible;">></a>
        <div id="area">

        </div>



        
<script>
    // Get the search parameters from the URL
    const searchParams = new URLSearchParams(window.location.search);

    // Get the value of the 'bookurl' parameter
    const bookUrl = searchParams.get('bookurl');

    // Print the value of the 'bookurl' parameter
    console.log('Loading ' + bookUrl);

   const bookname = bookUrl;
    // Load the opf
    var book = ePub(bookname);
    var rendition = book.renderTo("area", {
      width: "100%",
      height: 600,
      spread: "always"
    });

    rendition.display();

    book.ready.then(() => {

var next = document.getElementById("next");

next.addEventListener("click", function(e){
  book.package.metadata.direction === "rtl" ? rendition.prev() : rendition.next();
  e.preventDefault();
  saveViewerState();
})

}, false);

var prev = document.getElementById("prev");
prev.addEventListener("click", function(e){
  book.package.metadata.direction === "rtl" ? rendition.next() : rendition.prev();
  e.preventDefault();
  saveViewerState();
}, false);

var keyListener = function(e){

  // Left Key
  if ((e.keyCode || e.which) == 37) {
    book.package.metadata.direction === "rtl" ? rendition.next() : rendition.prev();
  }

  // Right Key
  if ((e.keyCode || e.which) == 39) {
    book.package.metadata.direction === "rtl" ? rendition.prev() : rendition.next();
  }

};

rendition.on("keyup", keyListener);
document.addEventListener("keyup", keyListener, false);

function saveViewerState() {
  if (rendition && rendition.location && rendition.location.start) {
    // get the current location
var currentLocation = rendition.currentLocation();

// save the current location in localStorage
localStorage.setItem(bookname, JSON.stringify(currentLocation));
}
}

// Retrieve the saved state from local storage and set the book to the saved page
function setBookToSavedState() {
  // get the saved location from localStorage
var savedLocation = localStorage.getItem(bookname);

// display the saved location
//book.locations.currentLocation = savedLocation;
rendition.display(JSON.parse(savedLocation).start.cfi);
//console.log(rendition.currentLocation);
}

function nextUntilLocationMatched() { //NOT NEEDED ANYMORE. stopgap to auto-page to saved state because was running into issues. 
    // Load the saved location from local storage
const savedLocation = JSON.parse(localStorage.getItem(bookname));

// Navigate through the book until the current location matches the saved location
const navigateToSavedLocation = () => {
  const currentLocation = rendition.currentLocation();
  if (currentLocation.start.index !== savedLocation.start.index ||
      currentLocation.start.href !== savedLocation.start.href ||
      currentLocation.start.cfi !== savedLocation.start.cfi) {
    rendition.next();
    setTimeout(navigateToSavedLocation, 80); // Set a delay to allow the next page to load
  }
};

// Call the navigateToSavedLocation function to start navigating to the saved location
navigateToSavedLocation();
}

function getSavedLocation() {
    return JSON.parse(localStorage.getItem(bookname));
}

setTimeout(setBookToSavedState, 1200); 

  </script>

    </body>
</html>